<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GBS Americas SGS del Perú</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">


    
</head>
<body>

    <header class="main-header">
        <div class="header-container">
            <div class="logo-search-section">
                <div class="logo">
                    <span class="sgs-text">SGS</span>
                </div>
                <span class="sgs-world-text">GBS Americas - SGS del Perú SAC</span>
                
            </div>

        </div>
    </header>

    <nav class="secondary-nav">
        <ul class="nav-links">
            <li><a href="Otc.html">OTC Unbill Revenue</a></li>
            <li><a href="BadDebt.html">Bad Debt Report</a></li>
            <li><a href="Ingresos_Diferidos.html">Ingresos Diferidos</a></li>
            <li><a href="Asientos_Manuales.html">Asientos Manuales</a></li>
            <li><a href="Unidentify.html">Unidentify Report</a></li>
            <li><a href="index.html">Ageing Report</a></li>
            <li><a href="Autodetracciones.html">Autodetracciones</a></li>
            <li><a href="CashApp.html">CashApp</a></li>
            <li><a href="Detracciones.html">Detracciones</a></li>
            <li><a href="CastigoUR.html">Castigo UR</a></li> 
        </ul>
    </nav>

    <main class="tool-section">
        <h1>Bad Debt Report</h1>

        <h2 class="h2">Descarga reporte en Oracle</h2>

        <p class="sgs-world-text">1. Desde Oracle, se debe ejecutar el reporte con fecha del día: Request - Submit New Request - SGS Ageing Detail RetroActive TEXT (ALL) - </p>
        
            <div class="contenedor-imagen"> 
            <img src="Imagenes BadDebt/Bad_Parameters 1.png" alt="Bad Debt parametros de descarga" width="400" height="300">
            </div>

        <p class="sgs-world-text">2. En el momento que descarga, vamos a Actions - Zip and Download Output, el sistema descarga una carpeta comprimida, y en esta hay un archivo de texto.  </p>

        <p class="sgs-world-text">3. El archivo de texto lo vamos a guardar en la carpeta en nuestro equipo Bad Debt Report. (esta se debe configurar con el Senior encargado antes de ejecutar)  </p>

            <div class="contenedor-imagen"> 
            <img src="Imagenes BadDebt/Carpeta Bad Debt Report 2.png" alt="Carpeta Bad Debt Report" width="200" height="100">
            </div>

        <p class="sgs-world-text">4. Si se va a ejecutar un Bad Debt Preliminar, dentro del mismo mes vamos a utilizar el archivo de excel Bad Debt Report Query PRELIMINAR, si se va ejecutar un Bad Debt final en diferente mes vamos a utilizar el archivo de excel Bad Debt Report Query    </p>

            <div class="contenedor-imagen"> 
            <img src="Imagenes BadDebt/Querys Bad Debt Report 3.png" alt="Excel Bad Debt Report" width="200" height="100">
            </div>

        <p class="sgs-world-text">5. En la pestaña Datos, vamos al botón Actualizar todo, esperamos a que el query se ejecute, este va a actualizar toda la información y generará gran parte del reporte.</p>

            <div class="contenedor-imagen"> 
            <img src="Imagenes BadDebt/Query 4.png" alt="Query Bad Debt Report" width="600" height="200">
            </div>

        <p class="sgs-world-text">6. En la hoja No olvidar copy Letras, vamos a copiar en valores la información y la vamos a pegar en la parte inferior de la data de la hoja Bad Debt Report.</p>

            <div class="contenedor-imagen"> 
            <img src="Imagenes BadDebt/Letras 5.png" alt="Query Bad Debt Report" width="600" height="400">
            </div>

        <p class="sgs-world-text">7. En la columna Sector de la hoja Bad Debt Report, vamos a realizar una limpieza de Cecos, especialmente en el sector 20. Se filtra por el sector 20 y en la columna Cost center verificamos que ningun cecos empiece por 1.</p>

            <div class="contenedor-imagen"> 
            <img src="Imagenes BadDebt/Sector 6.png" alt="Query Bad Debt Report" width="300" height="300">
            </div>
    
        <p class="sgs-world-text">8. Vamos a reemplazar manualmente cada uno de los Cecos que empiezan por uno, reemplazando según el listado de Cecos actualizado.</p>

            <div class="contenedor-imagen"> 
            <img src="Imagenes BadDebt/Cecos 7.png" alt="Query Bad Debt Report" width="300" height="300">
            </div>    
            
        <p class="sgs-world-text">9. Para realizar el cálculo vamos a tener en cuenta la tasa de cambio del día del cierre. Esta será confirmada por el equipo local.

        Después de generado nuestro reporte, verificamos que el query ejecute la siguiente opción de incluir una columna entre la columna BO “Castigo Acumulado (PEN) y la columna BP Glosa. Para incluir la columna “Castigo Calculado Tasa del cierre” quedando de la siguiente manera.
        </p>

            <div class="contenedor-imagen"> 
            <img src="Imagenes BadDebt/Columna Castigo Nueva.png" alt="Columna Castigo Nueva" width="600" height="300">
            </div>  

        <p class="sgs-world-text">En la columna “Castigo Calculado Tasa del cierre” vamos a calcular el castigo con la siguiente formula, teniendo en cuenta que la tasa de cambio que vamos a utilizar (esta en la multiplicación *3.36685 de la formula), la debe confirmar el equipo local : </p>

        <p class="sgs-world-text">=SI([@Moneda]="PEN";[@[Saldo Pdte.]]*[@[% Castigo]];([@[Saldo Pdte.]]*3.36685)*[@[% Castigo]]) </p>

        
        <p class="sgs-world-text">Copiamos la formula en todas las columnas incluyendo las letras.

        </p>
    
        <p class="sgs-world-text">10. El la hoja Resumen se van a actualizar las 3 tablas dinamicas.</p>

            <div class="contenedor-imagen"> 
            <img src="Imagenes BadDebt/td 8.png" alt="Query Bad Debt Report" width="600" height="300">
            </div> 

        <p class="sgs-world-text">11. Se envia el correo a las personas encargadas para su aprobación, indicando el valor del Bad Debt según la tabla dinamica.</p>

             <div class="contenedor-imagen"> 
            <img src="Imagenes BadDebt/Correo.png" alt="Correo" width="600" height="300">
            </div> 

        
        
        <h2 class="h2">Asiento contable Bad Debt</h2>

     
    <div class="tool-card">
        <p>Selecciona tu archivo de Excel para procesar. El programa seleccionará las columnas clave y añadirá los campos necesarios.</p>

            <input type="file" id="fileInput" accept=".xlsx, .xls">

             <button id="downloadButton">⬇️ Descargar Archivo Depurado</button>

        <div id="message">Esperando archivo...</div>

    </div>

<script>
    const fileInput = document.getElementById('fileInput');
    const messageDiv = document.getElementById('message');
    const downloadButton = document.getElementById('downloadButton'); 
    
    // Contenedor para los nuevos botones de descarga
    const downloadContainer = document.createElement('div'); 
    downloadButton.parentNode.insertBefore(downloadContainer, downloadButton.nextSibling);
    downloadButton.style.display = 'none'; // Ocultamos el botón original

    // Definición de las columnas que deben permanecer
    const COLUMNAS_A_MANTENER = [
        'RECEIVABLE_ACCOUNT',
        'SECTOR',
        'COST CENTER',
        'LOCATION',
        'Glosa',
        'Castigo Calculado Tasa del cierre',
        'Moneda' 
    ];

    let processedData = {}; 
    let originalFileName = '';

    // Escucha cuando se selecciona un archivo
    fileInput.addEventListener('change', (event) => {
        const file = event.target.files[0];
        if (file) {
            originalFileName = file.name.replace(/\.[^/.]+$/, "");
            messageDiv.textContent = `Archivo cargado: ${file.name}. Filtrando ceros, ordenando y separando por moneda...`;
            messageDiv.style.backgroundColor = '#d1ecf1';
            messageDiv.style.color = '#0c5460';
            downloadContainer.innerHTML = ''; // Limpiamos botones de descargas anteriores
            readExcel(file);
        }
    });

    /**
     * Lee el archivo de Excel, extrae los datos, los filtra (quita ceros) y los ordena.
     * @param {File} file - El archivo seleccionado por el usuario.
     */
    function readExcel(file) {
        const reader = new FileReader();

        reader.onload = (e) => {
            try {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                
                const sheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[sheetName];

                let jsonSheet = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                
                if (jsonSheet.length < 2) {
                    messageDiv.textContent = '❌ Error: El archivo parece estar vacío o solo tiene encabezados.';
                    messageDiv.style.backgroundColor = '#f8d7da';
                    messageDiv.style.color = '#721c24';
                    return;
                }
                
                const headers = jsonSheet[0];
                let dataRows = jsonSheet.slice(1);

                // Obtener el índice de la columna a filtrar y ordenar
                const castigoIndex = headers.map(h => String(h).trim()).indexOf('Castigo Calculado Tasa del cierre');

                if (castigoIndex === -1) {
                    messageDiv.textContent = '❌ Error: La columna "Castigo Calculado Tasa del cierre" no fue encontrada en el archivo.';
                    messageDiv.style.backgroundColor = '#f8d7da';
                    messageDiv.style.color = '#721c24';
                    return;
                }
                
                // --- 1. FILTRAR: Quitar filas donde el monto sea 0 ---
                const initialLength = dataRows.length;
                dataRows = dataRows.filter(row => {
                    // Limpia el valor de la celda de caracteres no numéricos y lo convierte a número
                    const val = Number(String(row[castigoIndex]).replace(/[^0-9.-]/g, '')) || 0;
                    return val !== 0; // Solo mantiene las filas donde el valor NO es cero
                });
                const filteredLength = dataRows.length;
                
                // --- 2. ORDENAR LOS DATOS por "Castigo Calculado Tasa del cierre" (de menor a mayor) ---
                dataRows.sort((a, b) => {
                    // Se asegura que los valores se interpreten como números
                    const valA = Number(String(a[castigoIndex]).replace(/[^0-9.-]/g, '')) || 0;
                    const valB = Number(String(b[castigoIndex]).replace(/[^0-9.-]/g, '')) || 0;
                    return valA - valB;
                });
                
                // 3. Procesar, separar y ordenar las columnas
                const separatedData = processAndSeparateData(headers, dataRows);
                
                processedData = {};
                let totalRecordsOutput = 0;
                
                downloadContainer.innerHTML = ''; 

                // 4. Crear un libro de trabajo por cada moneda encontrada
                for (const currency in separatedData) {
                    const rows = separatedData[currency];
                    if (rows.length > 0) {
                        const newWorksheet = XLSX.utils.json_to_sheet(rows);
                        const newWorkbook = XLSX.utils.book_new();
                        XLSX.utils.book_append_sheet(newWorkbook, newWorksheet, `Reporte ${currency}`);
                        
                        processedData[currency] = newWorkbook;
                        totalRecordsOutput += rows.length;
                        
                        // Crear un botón de descarga por moneda
                        const button = document.createElement('button');
                        button.textContent = `⬇️ Descargar ${currency} Ordenado (${rows.length} registros)`;
                        button.className = 'download-currency-button';
                        button.style.cssText = 'padding: 10px 15px; background-color: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; margin-right: 10px; margin-top: 10px; font-weight: bold;';
                        
                        button.addEventListener('click', () => {
                            const timestamp = new Date().getTime();
                            const newFileName = `${originalFileName}_${currency}_ORDENADO_${timestamp}.xlsx`;
                            XLSX.writeFile(processedData[currency], newFileName);
                        });
                        downloadContainer.appendChild(button);
                    }
                }
                
                messageDiv.textContent = `✅ Archivo procesado con éxito. Filas eliminadas (Castigo = 0): ${initialLength - filteredLength}. Total de registros a descargar: ${totalRecordsOutput}.`;
                messageDiv.style.backgroundColor = '#d4edda';
                messageDiv.style.color = '#155724';

            } catch (error) {
                console.error("Error al procesar:", error);
                messageDiv.textContent = `❌ Error al procesar el archivo: ${error.message}. Asegúrate de que es un archivo Excel válido.`;
                messageDiv.style.backgroundColor = '#f8d7da';
                messageDiv.style.color = '#721c24';
            }
        };

        reader.onerror = (error) => {
            messageDiv.textContent = `❌ Error de lectura de archivo: ${error.message}`;
            messageDiv.style.backgroundColor = '#f8d7da';
            messageDiv.style.color = '#721c24';
        };

        reader.readAsArrayBuffer(file);
    }

    /**
     * Aplica el formato de columnas y separa los datos por la columna 'Moneda'.
     */
    function processAndSeparateData(headers, dataRows) {
        const separatedOutput = { 'PEN': [], 'USD': [] }; 

        const headerMap = new Map();
        headers.forEach((header, index) => {
            const cleanHeader = header ? String(header).trim() : null; 
            if (cleanHeader) {
                headerMap.set(cleanHeader, index);
            }
        });

        // Función auxiliar para obtener el valor de una columna original
        const getOriginalValue = (colName, row) => {
            const index = headerMap.get(colName);
            return (index !== undefined && row[index] !== undefined) ? row[index] : '';
        };


        dataRows.forEach(row => {
            // Obtener la moneda
            let currency = String(getOriginalValue('Moneda', row)).toUpperCase().trim();
            
            if (currency !== 'PEN' && currency !== 'USD') {
                return; 
            }

            // Aplicar el orden de columnas deseado:
            const newRow = {};
            
            // ************************************************
            // ORDEN DE COLUMNAS FINAL
            // ************************************************
            
            newRow['FCODE'] = 'F391501'; 
            newRow['RECEIVABLE_ACCOUNT'] = getOriginalValue('RECEIVABLE_ACCOUNT', row);
            newRow['SECTOR'] = getOriginalValue('SECTOR', row);
            newRow['ACT'] = '000000'; 
            newRow['COST CENTER'] = getOriginalValue('COST CENTER', row);
            newRow['CL'] = '00';
            newRow['LOCATION'] = getOriginalValue('LOCATION', row); 
            newRow['INTERCOMPANY'] = '0000000';
            newRow['PROJECT'] = '00000000';
            newRow['STATUTORY'] = 'B';
            newRow['RESERVED 1'] = '000000';
            newRow['RESERVED 2'] = '000000';
            newRow['DEBE'] = '0'; // Valor fijo que agregaste en el script que enviaste
            newRow['Castigo Calculado Tasa del cierre'] = getOriginalValue('Castigo Calculado Tasa del cierre', row);
            newRow['Glosa'] = getOriginalValue('Glosa', row);
            
            // ************************************************
            
            // Separar la fila en el array correspondiente (PEN o USD)
            separatedOutput[currency].push(newRow);
        });

        return separatedOutput;
    }
</script>

        <p class="sgs-world-text">1. Cuando descargues el archivo en excel, encontraras el primer asiento contable, de las cuentas 1600131 y 1600132, lo primero que vas a verificar es si el valor esta en negativo en el haber, pasalo al DEBE en positivo</p>

        <p class="sgs-world-text">2. Ahora tienes que crear la segunda parte donde hacemos la contrapartida con la cuenta 1600911. Copiamos el mismo asiento volteando el debe y el haber y cambiamos la cuenta.</p>

            <div class="contenedor-imagen"> 
            <img src="Imagenes BadDebt/asiento 9.png" alt="Query Bad Debt Report" width="800" height="300">
            </div>

        <p class="sgs-world-text">3. Haz una copia del primer asiento y llamalo Sectores, manten la primera parte del asiento, y borra todas las cuentas.</p>

            <div class="contenedor-imagen"> 
            <img src="Imagenes BadDebt/asiento 10.png" alt="Query Bad Debt Report" width="800" height="300">
            </div>

        <p class="sgs-world-text">4. Ahora se debe hacer un cruce de información con la siguiente tabla. Puedes hacer un buscarv en excel con la información.</p>



        <table class="tabla-contable">
    <thead>
        <tr>
            <th>SECTOR</th>
            <th>CTA</th>

        </tr>
    </thead>
    <tbody>
        <tr>
            <td>10</td>
            <td>1610111</td>
        </tr>
        <tr>
            <td>20</td>
            <td>1610112</td>
        </tr>
        <tr>
            <td>40</td>
            <td>1610113</td>
        </tr>
        <tr>
            <td>90</td>
            <td>1610115</td>
        </tr>
        <tr>
            <td>500</td>
            <td>1610114</td>
        </tr>

    </table>



        <p class="sgs-world-text">5. =BUSCARV(C2;CC!$A$1:$B$6;2;0) Puedes crear una hoja llamada CC con,los datos de la tabla y hacer el cruce con esta formula, el archivo te debe quedar como el siguiente ejemplo.</p>

            <div class="contenedor-imagen"> 
            <img src="Imagenes BadDebt/asiento 12.png" alt="Query Bad Debt Report" width="800" height="300">
            </div>

        <p class="sgs-world-text">6. La segunda parte del asiento es la contrapartida, vamos a voltear la cuenta debe y el haber, segundo copiamos la información y vamos a borrar la columna RECEIVABLE_ACCOUNT y vamos a dejar solo la cuenta 5501411, y borramos SECTOR, ACT y CL.</p>
 
             <div class="contenedor-imagen"> 
            <img src="Imagenes BadDebt/asiento 13.png" alt="Query Bad Debt Report" width="800" height="300">
            </div>

        <p class="sgs-world-text">7. Ahora vamos a trabajar con el listado de Cecos Actualizado, este es compartido por el equipo local o R2R. Lo que queremos buscar es según el COST CENTER, vamos a buscar el SECTOR, ACT, y CL. Esto lo vamos a hacer con formulas buscarv. Concejo, puedes hacer una tabla con la información en la hoja CC que creamos para hacer el cruce de Sectores, solo incluye las columnas CeCo, Sector, Code_Activity, CL, CONCATENAR del listado de Cecos. </p>

            <div class="contenedor-imagen"> 
            <img src="Imagenes BadDebt/asiento 14.png" alt="Query Bad Debt Report" width="600" height="300">
            </div>

        <p class="sgs-world-text">8. Vamos a hacer 3 Buscarv, para cruzar la Información. Este paso es importante ya que estamos haciendo la validación de Cecos actualizados.</p>
        <p class="sgs-world-text">Columna SECTOR, =BUSCARV(E482;CC!E:I;2;0).</p>
        <p class="sgs-world-text">Columna ACT, =BUSCARV(E482;CC!E:I;3;0).</p>
        <p class="sgs-world-text">Columna ACT, =BUSCARV(E482;CC!E:I;4;0).</p>
        <p class="sgs-world-text-2">Debes tener presente la celda que estas buscando de referencia, si vas a copiar la formula</p>
     
            <div class="contenedor-imagen"> 
            <img src="Imagenes BadDebt/asiento 15.png" alt="Query Bad Debt Report" width="600" height="300">
            </div>

        <p class="sgs-world-text">9. Copias la formula en todos los datos y ya tenemos el ultimo asiento.</p> 

        <p class="sgs-world-text-2">10. Estos mismos pasos los debes hacer para el Asiento en PEN y en USD.</p>

        <p class="sgs-world-text">11. Recuerda que cada archivo es un Asiento para cargar en Oracle, recomendación utiliza un Web Adi con Accrual Autoreverse.</p>

        <p class="sgs-world-text">12. Vamos a descargar un WebAdi SGS functional actuals - single details y lo trabajaremos como Accrual Autoreverse, lo llamaremos JM_COBRANZA DUDOSA_SOLES DEC2025, esto para PEN.</p>

        <p class="sgs-world-text">13. Vamos a descargar un WebAdi SGS Foreing actuals - single extended y lo trabajaremos como Accrual Autoreverse, lo llamaremos JM_COBRANZA DUDOSA_DOLARES DEC2025, esto para USD.</p>

        <p class="sgs-world-text">14. Cuando finalice el proceso de WebAdi, ingresamos a Oracle y buscamos los asientos, adjuntamos los soportes y Posteamos </p>


    </main>

    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
    <script src="converter.js"></script>

</body>
</html>